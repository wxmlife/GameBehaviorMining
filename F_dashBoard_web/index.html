<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>å­¦ç”Ÿæ¸¸æˆè¡Œä¸ºåˆ†æä»ªè¡¨ç›˜</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
      body {
        font-family: "Helvetica Neue", Arial, sans-serif;
        margin: 20px;
        background: #f5f7fa;
      }
      h1,
      h2 {
        color: #333;
      }
      .chart-box {
        background: #fff;
        padding: 20px;
        margin-bottom: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }
      select {
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ“Š å­¦ç”Ÿæ¸¸æˆè¡Œä¸ºç”»åƒä»ªè¡¨ç›˜</h1>

    <!-- ç­çº§ & å­¦ç”Ÿé€‰æ‹© -->
    <div>
      <label>é€‰æ‹©ç­çº§ï¼š</label>
      <select id="classSelect"></select>
      <label>é€‰æ‹©å­¦å·ï¼š</label>
      <select id="stuSelect"></select>
    </div>

    <!-- å›¾1ï¼šè¡Œä¸ºæ¬¡æ•°å¯¹æ¯” -->
    <div class="chart-box" id="countBar"></div>
    <!-- å›¾2ï¼šè¡Œä¸ºæ—¶é•¿å¯¹æ¯” -->
    <div class="chart-box" id="durationBar"></div>

    <script>
      // ===== é€šç”¨ï¼šåŠ è½½ JSON =====
      async function loadJSON(file) {
        const res = await fetch("data/" + file);
        return res.json();
      }

      // ===== åˆå§‹åŒ–ï¼šå¡«å……ç­çº§ä¸‹æ‹‰æ¡† =====
      (async function initClassSelect() {
        const stuData = await loadJSON("æ¯ä¸ªå­¦ç”Ÿæ¸¸æˆè¡Œä¸ºç”»åƒ.json");
        // å»é‡ç­çº§åˆ—è¡¨
        const classes = [...new Set(stuData.map((d) => d.Class))];
        const classSel = document.getElementById("classSelect");
        classes.forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c;
          opt.textContent = c;
          classSel.appendChild(opt);
        });
        classSel.addEventListener("change", fillStudentSelect);
        classSel.dispatchEvent(new Event("change")); // è§¦å‘ä¸€æ¬¡ï¼Œå¡«å……å­¦ç”Ÿ
      })();

      // ===== å¡«å……å­¦ç”Ÿä¸‹æ‹‰æ¡†ï¼ˆä»å­¦ç”Ÿç”»åƒé‡Œè¯»ï¼‰=====
      async function fillStudentSelect() {
        const cls = document.getElementById("classSelect").value;
        const stuData = await loadJSON("æ¯ä¸ªå­¦ç”Ÿæ¸¸æˆè¡Œä¸ºç”»åƒ.json");
        // åªä¿ç•™å½“å‰ç­çº§çš„å­¦ç”Ÿ
        const stus = stuData
          .filter((d) => d.Class === cls)
          .map((d) => d.StuNum);
        const stuSel = document.getElementById("stuSelect");
        stuSel.innerHTML = "";
        stus.forEach((s) => {
          const opt = document.createElement("option");
          opt.value = s;
          opt.textContent = s;
          stuSel.appendChild(opt);
        });
        // é»˜è®¤è§¦å‘ä¸€æ¬¡æ›´æ–°å›¾è¡¨
        stuSel.dispatchEvent(new Event("change"));
      }

      // ===== ä¸»å‡½æ•°ï¼šæ›´æ–°æ‰€æœ‰å›¾è¡¨ =====
      async function updateCharts() {
        const cls = document.getElementById("classSelect").value;
        const stu = document.getElementById("stuSelect").value;
        if (!cls || !stu) return;

        const [stuData, clsData] = await Promise.all([
          loadJSON("æ¯ä¸ªå­¦ç”Ÿæ¸¸æˆè¡Œä¸ºç”»åƒ.json").then((arr) =>
            arr.find((d) => d.Class === cls && d.StuNum === stu)
          ),
          loadJSON("ç­çº§è¡Œä¸ºç”»åƒ.json").then((arr) =>
            arr.find((d) => d.Class === cls)
          ),
        ]);

        // è‹¥æ‰¾ä¸åˆ°å­¦ç”Ÿï¼Œç›´æ¥è¿”å›
        if (!stuData) {
          console.warn("æœªæ‰¾åˆ°è¯¥å­¦ç”Ÿ");
          return;
        }

        // 1ï¸âƒ£ è¡Œä¸ºæ¬¡æ•°å¯¹æ¯”
        drawCountBar(stuData, clsData);
        // 2ï¸âƒ£ è¡Œä¸ºæ—¶é•¿å¯¹æ¯”
        drawDurationBar(stuData, clsData);
      }

      // ===== å›¾è¡¨1ï¼šè¡Œä¸ºæ¬¡æ•°å¯¹æ¯” =====
      function drawCountBar(stu, cls) {
        const categories = ["é˜…è¯»", "æ¢ç´¢", "ç»ƒä¹ ", "åé¦ˆ", "é‡ç©/ç»“æŸ"];
        const stuCounts = categories.map(
          (_, i) =>
            stu[
              `round1_${
                ["read", "explore", "practice", "feedback", "replay_end"][i]
              }_count`
            ] || 0
        );
        const clsCounts = categories.map(
          (_, i) =>
            cls[
              `class_avg_round1_${
                ["read", "explore", "practice", "feedback", "replay_end"][i]
              }_count`
            ] || 0
        );

        const chart = echarts.init(document.getElementById("countBar"));
        chart.setOption({
          title: { text: "è¡Œä¸ºæ¬¡æ•°å¯¹æ¯”ï¼ˆå­¦ç”Ÿ vs ç­çº§å¹³å‡ï¼‰" },
          tooltip: { trigger: "axis" },
          legend: { data: ["å­¦ç”Ÿæ¬¡æ•°", "ç­çº§å¹³å‡"] },
          xAxis: { type: "category", data: categories },
          yAxis: { type: "value" },
          series: [
            {
              name: "å­¦ç”Ÿæ¬¡æ•°",
              type: "bar",
              data: stuCounts,
              itemStyle: { color: "#5470c6" },
            },
            {
              name: "ç­çº§å¹³å‡",
              type: "bar",
              data: clsCounts,
              itemStyle: { color: "#91cc75" },
            },
          ],
        });
      }

      // ===== å›¾è¡¨2ï¼šè¡Œä¸ºæ—¶é•¿å¯¹æ¯” =====
      function drawDurationBar(stu, cls) {
        const categories = ["é˜…è¯»", "æ¢ç´¢", "ç»ƒä¹ ", "åé¦ˆ", "é‡ç©/ç»“æŸ"];
        const stuDurs = categories.map(
          (_, i) =>
            stu[
              `round1_${
                ["read", "explore", "practice", "feedback", "replay_end"][i]
              }_duration`
            ] || 0
        );
        const clsDurs = categories.map(
          (_, i) =>
            cls[
              `class_avg_round1_${
                ["read", "explore", "practice", "feedback", "replay_end"][i]
              }_duration`
            ] || 0
        );

        const chart = echarts.init(document.getElementById("durationBar"));
        chart.setOption({
          title: { text: "è¡Œä¸ºæ—¶é•¿å¯¹æ¯”ï¼ˆå­¦ç”Ÿ vs ç­çº§å¹³å‡ï¼‰" },
          tooltip: { trigger: "axis" },
          legend: { data: ["å­¦ç”Ÿæ—¶é•¿", "ç­çº§å¹³å‡"] },
          xAxis: { type: "category", data: categories },
          yAxis: { type: "value" },
          series: [
            {
              name: "å­¦ç”Ÿæ—¶é•¿",
              type: "bar",
              data: stuDurs,
              itemStyle: { color: "#5470c6" },
            },
            {
              name: "ç­çº§å¹³å‡",
              type: "bar",
              data: clsDurs,
              itemStyle: { color: "#91cc75" },
            },
          ],
        });
      }

      // ===== å›¾è¡¨3ï¼šæ¸¸æˆæˆç»©æŠ˜çº¿ =====
      function drawScoreLine(stu, cls) {
        const rounds = [1, 2, 3, 4, 5];
        const stuScores = rounds.map((r) => stu[`game_score_${r}`] || 0);
        const clsScores = rounds.map(
          (r) => cls[`class_avg_game_score_${r}`] || 0
        );

        const chart = echarts.init(document.getElementById("scoreLine"));
        chart.setOption({
          title: { text: "æ¸¸æˆæˆç»©å¯¹æ¯”ï¼ˆå­¦ç”Ÿ vs ç­çº§å¹³å‡ï¼‰" },
          tooltip: { trigger: "axis" },
          legend: { data: ["å­¦ç”Ÿæˆç»©", "ç­çº§å¹³å‡"] },
          xAxis: { type: "category", data: rounds },
          yAxis: { type: "value" },
          series: [
            {
              name: "å­¦ç”Ÿæˆç»©",
              type: "line",
              data: stuScores,
              lineStyle: { color: "#5470c6" },
              symbol: "circle",
            },
            {
              name: "ç­çº§å¹³å‡",
              type: "line",
              data: clsScores,
              lineStyle: { color: "#91cc75", type: "dashed" },
              symbol: "none",
            },
          ],
        });
      }
    </script>
  </body>
</html>
